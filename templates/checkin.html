{% extends "layout.html" %}
{% block title %}Nouveau Check-in{% endblock %}

{% block content %}
    <h1>Nouveau Check-in</h1>
    <p>Sélectionnez une réservation existante ou remplissez les informations manuellement.</p>

    <!-- Section pour les réservations du jour -->
    <div class="widget-card" style="margin-bottom: 2rem;">
        <h4>Arrivées Prévues Aujourd'hui</h4>
        <div class="arrivals-list">
            {% for arrival in todays_arrivals %}
                <button class="arrival-btn"
                        data-client="{{ arrival.client_nom }}"
                        data-room-id="{{ arrival.chambre_id }}"
                        data-room-details="Ch. {{ arrival.numero }} ({{ arrival.type_chambre }})"
                        data-checkout="{{ arrival.date_fin }}">
                    <strong>{{ arrival.client_nom }}</strong> (Ch. {{ arrival.numero }})
                </button>
            {% else %}
                <p>Aucune réservation pour aujourd'hui.</p>
            {% endfor %}
        </div>
    </div>

    <form method="POST" action="{{ url_for('create_checkin') }}" class="dashboard-table" style="padding: 2rem;">
        
        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="client_nom" style="font-weight: 600;">Nom du Client :</label>
            <input type="text" id="client_nom" name="client_nom" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-top: 0.5rem;">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="chambre_id" style="font-weight: 600;">Chambre :</label>
            <select id="chambre_id" name="chambre_id" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; margin-top: 0.5rem; background-color: white;">
                {% for room in available_rooms %}
                    <option value="{{ room.id }}">
                        Ch. {{ room.numero }} ({{ room.type_chambre }})
                    </option>
                {% endfor %}
                 <!-- Les chambres réservées seront ajoutées dynamiquement ici -->
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="date_checkout_prevue" style="font-weight: 600;">Date de Départ Prévue :</label>
            <input type="date" id="date_checkout_prevue" name="date_checkout_prevue" value="{{ default_checkout_date }}" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-top: 0.5rem;">
        </div>

        <button type="submit" class="btn btn-primary">Confirmer le Check-in</button>
        <a href="{{ url_for('reception') }}" style="margin-left: 1rem; color: #777;">Annuler</a>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const arrivalButtons = document.querySelectorAll('.arrival-btn');
        const clientNameInput = document.getElementById('client_nom');
        const roomSelect = document.getElementById('chambre_id');
        const checkoutInput = document.getElementById('date_checkout_prevue');

        arrivalButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Empêche la soumission du formulaire

                // Remplir les champs
                clientNameInput.value = this.dataset.client;
                checkoutInput.value = this.dataset.checkout;

                const roomId = this.dataset.roomId;
                const roomDetails = this.dataset.roomDetails;

                // Vérifier si l'option de la chambre existe déjà
                let roomOption = roomSelect.querySelector(`option[value="${roomId}"]`);
                if (!roomOption) {
                    // Si elle n'existe pas (car la chambre est réservée), on l'ajoute
                    roomOption = document.createElement('option');
                    roomOption.value = roomId;
                    roomOption.textContent = roomDetails;
                    roomSelect.appendChild(roomOption);
                }

                // Sélectionner la chambre
                roomSelect.value = roomId;
            });
        });
    });
</script>
{% endblock %}
